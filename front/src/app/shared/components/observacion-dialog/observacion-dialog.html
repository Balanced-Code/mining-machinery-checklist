<!-- Backdrop -->
<div class="dialog-backdrop" (click)="cancelar()"></div>

<!-- Dialog Wrapper -->
<div class="dialog-wrapper">
  <!-- Dialog Container -->
  <div class="dialog-container" role="dialog" aria-modal="true">
    <!-- Header -->
    <div class="dialog-header">
      <div>
        <h2 class="dialog-title">{{ getTitulo() }}</h2>
        <p class="dialog-subtitle">{{ itemDescripcion() }}</p>
      </div>
      <button class="dialog-close" (click)="cancelar()" type="button" aria-label="Cerrar">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Content -->
    <div class="dialog-content">
      <!-- Observaciones -->
      <div class="form-field">
        <div class="field-label-row">
          <label class="field-label">Observaciones</label>
          @if (requiereObservacion() && esEditable()) {
          <span class="field-required">*</span>
          } @else if (esEditable()) {
          <span class="field-optional">(opcional)</span>
          }
        </div>

        @if (esEditable()) {
        <textarea
          class="field-textarea"
          [class.required]="requiereObservacion()"
          [class.invalid]="!descripcionValida() || !tieneContenido()"
          placeholder="Las observaciones son obligatorias para items marcados como NO..."
          [value]="descripcion()"
          (input)="updateDescripcion($any($event.target).value)"
          rows="6"
        ></textarea>

        @if (mensajeValidacion()) {
        <p class="field-warning">
          <mat-icon class="warning-icon">warning</mat-icon>
          {{ mensajeValidacion() }}
        </p>
        } } @else {
        <div class="field-value">
          {{ descripcion() || 'Sin observaciones' }}
        </div>
        }
      </div>

      <!-- Archivos Adjuntos -->
      <div class="form-field">
        <div class="field-label-row">
          <label class="field-label">Archivos Adjuntos</label>
          @if (esEditable()) {
          <span class="field-optional">(opcional)</span>
          }
        </div>

        <!-- Upload (solo si es editable) -->
        @if (esEditable()) {
        <label class="file-upload-label" for="file-upload">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <span class="upload-text">
            Haz clic para subir archivos (imágenes, PDFs, documentos)
          </span>
          <input
            type="file"
            id="file-upload"
            accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
            multiple
            (change)="onFileSelect($event)"
            hidden
          />
        </label>
        }

        <!-- Lista de archivos -->
        <div class="files-container">
          <!-- Archivos existentes del servidor -->
          @for (archivo of archivosExistentes(); track archivo.id; let i = $index) {
          <div class="file-item">
            <!-- Preview para imágenes -->
            @if (archivo.tipo.startsWith('image/')) {
            <div
              class="file-preview image-preview clickable"
              (click)="abrirVisorImagen(getArchivoUrl(archivo))"
              title="Click para ver en grande"
            >
              <img [src]="getArchivoUrl(archivo)" [alt]="archivo.nombre" />
            </div>
            } @else {
            <!-- Ícono para otros tipos de archivo -->
            <div class="file-preview icon-preview">
              <mat-icon class="file-icon">{{
                archivoService.getIconoPorTipo(archivo.tipo)
              }}</mat-icon>
            </div>
            }

            <div class="file-info">
              <div class="file-name" [title]="archivo.nombre">{{ archivo.nombre }}</div>
              <div class="file-meta">
                {{ archivoService.formatearTamano(archivo.tamano) }}
              </div>
            </div>

            <div class="file-actions">
              @if (!esEditable()) {
              <button
                class="file-action-btn"
                (click)="descargarArchivo(archivo)"
                type="button"
                title="Descargar"
                aria-label="Descargar archivo"
              >
                <mat-icon>download</mat-icon>
              </button>
              } @if (esEditable()) {
              <button
                class="file-action-btn delete"
                (click)="eliminarArchivoExistente(i)"
                type="button"
                title="Eliminar"
                aria-label="Eliminar archivo"
              >
                <mat-icon>delete</mat-icon>
              </button>
              }
            </div>
          </div>
          }

          <!-- Archivos nuevos (pendientes de subir) -->
          @for (file of archivosNuevos(); track $index; let i = $index) {
          <div class="file-item new-file">
            <!-- Preview para imágenes nuevas -->
            @if (file.type.startsWith('image/')) {
            <div
              class="file-preview image-preview clickable"
              (click)="abrirVisorImagen(getPreviewNuevo(file))"
              title="Click para ver en grande"
            >
              <img [src]="getPreviewNuevo(file)" [alt]="file.name" />
            </div>
            } @else {
            <!-- Ícono para otros tipos de archivo -->
            <div class="file-preview icon-preview">
              <mat-icon class="file-icon">{{ archivoService.getIconoPorTipo(file.type) }}</mat-icon>
            </div>
            }

            <div class="file-info">
              <div class="file-name" [title]="file.name">{{ file.name }}</div>
              <div class="file-meta">
                {{ archivoService.formatearTamano(file.size) }} • Pendiente
              </div>
            </div>

            <div class="file-actions">
              @if (esEditable()) {
              <button
                class="file-action-btn delete"
                (click)="eliminarArchivoNuevo(i)"
                type="button"
                title="Eliminar"
                aria-label="Eliminar archivo"
              >
                <mat-icon>delete</mat-icon>
              </button>
              }
            </div>
          </div>
          }

          <!-- Estado vacío -->
          @if (archivosExistentes().length === 0 && archivosNuevos().length === 0) {
          <div class="empty-files">
            <mat-icon class="empty-icon">insert_drive_file</mat-icon>
            <p class="empty-text">No hay archivos adjuntos</p>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="dialog-footer">
      @if (esEditable()) {
      <div class="footer-left">
        @if (modo() === 'editar') {
        <button class="btn-delete" (click)="eliminar()" type="button" title="Eliminar observación">
          <mat-icon>delete</mat-icon>
          Eliminar
        </button>
        }
      </div>
      <div class="footer-right">
        <button class="btn-cancel" (click)="cancelar()" type="button">Cancelar</button>
        <button class="btn-confirm" (click)="guardar()" type="button" [disabled]="!puedeGuardar()">
          Guardar
        </button>
      </div>
      } @else {
      <button class="btn-confirm" (click)="cancelar()" type="button">Cerrar</button>
      }
    </div>
  </div>
</div>

<!-- Visor de Imagen en Grande -->
@if (imagenVistaPrevia()) {
<div class="image-viewer-backdrop" (click)="cerrarVisorImagen($event)">
  <div class="image-viewer-container">
    <button
      class="image-viewer-close"
      (click)="cerrarVisorImagen()"
      type="button"
      aria-label="Cerrar"
    >
      <mat-icon>close</mat-icon>
    </button>
    <img
      [src]="imagenVistaPrevia()"
      alt="Vista previa"
      class="image-viewer-img"
      [class.zoomed]="imagenZoom()"
      (dblclick)="toggleZoomImagen($event)"
      title="Doble click para zoom"
    />
  </div>
</div>
}
