<!-- Backdrop -->
<div class="dialog-backdrop" (click)="close()"></div>

<!-- Dialog Wrapper -->
<div class="dialog-wrapper">
  <!-- Dialog -->
  <div class="dialog-container" role="dialog" aria-modal="true">
    <!-- Header -->
    <div class="dialog-header">
      <div>
        <h2>{{ mode() === 'create' ? 'Crear Usuario' : 'Editar Usuario' }}</h2>
        <p>
          {{
            mode() === 'create'
              ? 'Ingresa la información del nuevo usuario'
              : 'Modifica la información del usuario existente'
          }}
        </p>
      </div>
      <button class="close-btn" (click)="close()" type="button" aria-label="Cerrar">
        <span class="material-icons">close</span>
      </button>
    </div>

    <!-- Form -->
    <form class="dialog-form" (ngSubmit)="save()" #userForm="ngForm">
      <!-- Nombre Completo -->
      <div class="form-field">
        <label for="nombre">
          Nombre Completo
          <span class="required">*</span>
        </label>
        <input
          id="nombre"
          type="text"
          class="form-input"
          placeholder="Juan Pérez"
          [(ngModel)]="formData.nombre"
          name="nombre"
          required
          minlength="3"
          maxlength="80"
          pattern="^[A-Za-zÀ-ÿ\u00f1\u00d1\s]+$"
          [class.error]="nombreInput.invalid && nombreInput.touched"
          #nombreInput="ngModel"
        />
        @if (nombreInput.invalid && nombreInput.touched) {
        <p class="error-message">{{ getNombreError() }}</p>
        }
      </div>

      <!-- Correo Electrónico Corporativo -->
      <div class="form-field">
        <label for="correo">
          Correo Electrónico Corporativo
          <span class="required">*</span>
        </label>
        <input
          id="correo"
          type="email"
          class="form-input"
          placeholder="juan.perez@normet.com"
          [(ngModel)]="formData.correo"
          name="correo"
          required
          email
          pattern="^[a-zA-Z0-9._%+-]+@normet\.com$"
          [class.error]="correoInput.invalid && correoInput.touched"
          [disabled]="mode() === 'edit'"
          #correoInput="ngModel"
        />
        @if (correoInput.invalid && correoInput.touched && mode() === 'create') {
        <p class="error-message">{{ getCorreoError() }}</p>
        }
      </div>

      <!-- Rol del Usuario -->
      <div class="form-field">
        <label for="cargo">
          Rol del Usuario
          <span class="required">*</span>
        </label>
        <div class="select-wrapper">
          <select
            id="cargo"
            class="form-select"
            [(ngModel)]="formData.cargoId"
            name="cargoId"
            required
            #cargoInput="ngModel"
          >
            <option [ngValue]="null" disabled>Seleccionar rol</option>
            @for (cargo of cargos(); track cargo.id) {
            <option [ngValue]="cargo.id">{{ cargo.nombre }}</option>
            }
          </select>
          <span class="material-icons select-icon">expand_more</span>
        </div>
      </div>

      @if (mode() === 'edit') {
      <!-- Sección de Estado del Usuario (solo en edición) -->
      <div class="status-section">
        <div class="status-header">
          <span class="material-icons">{{ isUserActive() ? 'check_circle' : 'cancel' }}</span>
          <label>Estado de la Cuenta</label>
        </div>
        <div class="status-display" [class.active]="isUserActive()">
          <span class="status-indicator"></span>
          <span class="status-text">{{
            isUserActive() ? 'Usuario Activo' : 'Usuario Desactivado'
          }}</span>
        </div>
        <button
          class="toggle-status-btn"
          [class.deactivate]="isUserActive()"
          [class.activate]="!isUserActive()"
          (click)="toggleStatusClick()"
          type="button"
        >
          <span class="material-icons">{{ isUserActive() ? 'block' : 'check_circle' }}</span>
          {{ isUserActive() ? 'Desactivar Usuario' : 'Activar Usuario' }}
        </button>
      </div>

      <!-- Sección de Contraseña (solo en edición) -->
      <div class="password-section">
        <div class="password-header">
          <span class="material-icons">lock</span>
          <label>Restablecer Contraseña</label>
        </div>
        <button class="reset-password-btn" (click)="resetPasswordClick()" type="button">
          <span class="material-icons">lock_reset</span>
          Restablecer Contraseña
        </button>
      </div>
      }

      <!-- Sección de Contraseña (solo en creación) -->
      @if (mode() === 'create') {
      <div class="password-section">
        <div class="password-header">
          <span class="material-icons">lock</span>
          <label>Contraseña</label>
        </div>
        <div
          class="password-display"
          (click)="copyPassword()"
          [class.copied]="passwordCopied()"
          title="Click para copiar"
        >
          <span class="material-icons copy-icon">{{
            passwordCopied() ? 'check' : 'content_copy'
          }}</span>
          <span class="password-text">{{ generatedPassword }}</span>
        </div>
      </div>
      }

      <!-- Footer -->
      <div class="dialog-footer">
        <button class="btn-cancel" (click)="close()" type="button">Cancelar</button>
        <button class="btn-save" type="submit" [disabled]="!userForm.valid || saving()">
          {{ mode() === 'create' ? 'Crear' : 'Guardar Cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Diálogo de confirmación para restablecer contraseña -->
@if (showResetConfirm()) {
<app-confirm-dialog
  [title]="'Restablecer contraseña'"
  [message]="
    '¿Estás seguro de restablecer la contraseña de este usuario?\n\nLa nueva contraseña será: Password123?'
  "
  [confirmText]="'Restablecer'"
  [cancelText]="'Cancelar'"
  [type]="'warning'"
  (onConfirm)="confirmResetPassword()"
  (onCancel)="cancelResetPassword()"
/>
}

<!-- Diálogo de confirmación para cambiar estado -->
@if (showStatusConfirm()) {
<app-confirm-dialog
  [title]="isUserActive() ? 'Desactivar usuario' : 'Activar usuario'"
  [message]="
    isUserActive()
      ? '¿Estás seguro de desactivar este usuario?\n\nEl usuario no podrá acceder al sistema hasta que sea reactivado.'
      : '¿Estás seguro de activar este usuario?\n\nEl usuario podrá acceder al sistema nuevamente.'
  "
  [confirmText]="isUserActive() ? 'Desactivar' : 'Activar'"
  [cancelText]="'Cancelar'"
  [type]="isUserActive() ? 'danger' : 'info'"
  (onConfirm)="confirmToggleStatus()"
  (onCancel)="cancelToggleStatus()"
/>
}
