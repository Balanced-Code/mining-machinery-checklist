<div class="crear-inspeccion-container">
  <!-- Banner de error -->
  @if (inspeccionService.errorMessage()) {
  <div class="error-banner">
    <mat-icon>error_outline</mat-icon>
    <span>{{ inspeccionService.errorMessage() }}</span>
    <button class="btn-close-error" (click)="cerrarError()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  }

  <!-- Información General -->
  <div class="form-section">
    <div class="section-header">
      <div class="section-header-left">
        <mat-icon>info</mat-icon>
        <h2 class="section-title">Información General</h2>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-field">
        <label class="field-label"> Fecha de Inicio <span class="required">*</span> </label>
        <p-datepicker
          [(ngModel)]="fechaInicio"
          (ngModelChange)="onFechaHoraChange()"
          dateFormat="dd/mm/yy"
          placeholder="Seleccione fecha"
          [showIcon]="true"
          iconDisplay="input"
          [readonlyInput]="true"
          styleClass="w-full"
        />
      </div>
      <div class="form-field">
        <label class="field-label"> Hora de Inicio <span class="required">*</span> </label>
        <p-datepicker
          [(ngModel)]="horaInicio"
          (ngModelChange)="onFechaHoraChange()"
          [timeOnly]="true"
          hourFormat="24"
          placeholder="Seleccione hora"
          [showIcon]="true"
          iconDisplay="input"
          styleClass="w-full"
        />
      </div>
      <div class="form-field">
        <label class="field-label"> Número de Serie <span class="required">*</span> </label>
        <input
          type="text"
          class="field-input"
          [class.field-input-error]="errorNumSerie() || numSerieError()"
          placeholder="Ej: EQA-0332"
          [value]="numSerie()"
          (input)="numSerie.set($any($event.target).value); onNumSerieChange()"
          (blur)="validarNumeroSerie()"
        />
        @if (numSerieValidando()) {
        <span class="field-hint">Validando...</span>
        } @else if (numSerieError()) {
        <span class="field-error">{{ numSerieError() }}</span>
        } @else if (errorNumSerie()) {
        <span class="field-error">{{ errorNumSerie() }}</span>
        }
      </div>
      <div class="form-field">
        <label class="field-label"> Máquina <span class="required">*</span> </label>
        <mat-form-field class="field-select" [class.field-select-error]="errorMaquina()">
          <mat-select
            placeholder="Seleccione o cree una máquina"
            [value]="maquinaSeleccionada()"
            (selectionChange)="onMaquinaSelectionChange($event.value)"
            (openedChange)="$event ? null : searchMaquina.set('')"
          >
            <mat-option>
              <ngx-mat-select-search
                [(ngModel)]="searchMaquina"
                placeholderLabel="Buscar o crear..."
                noEntriesFoundLabel="No se encontraron máquinas"
              ></ngx-mat-select-search>
            </mat-option>
            <!-- Opción para crear nueva máquina si hay búsqueda y no coincide -->
            @if (searchMaquina() && !maquinaExacta() && searchMaquina().trim()) {
            <mat-option [value]="'__NUEVA__:' + searchMaquina()">
              <mat-icon class="option-icon-add">add_circle</mat-icon>
              <span class="option-create">Crear nueva: "{{ searchMaquina() }}"</span>
            </mat-option>
            }
            <!-- Lista de máquinas existentes -->
            @for (maquina of maquinasFiltradas(); track maquina.id) {
            <mat-option [value]="maquina.id">
              {{ maquina.nombre }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
        @if (errorMaquina()) {
        <span class="field-error">{{ errorMaquina() }}</span>
        }
      </div>
      <div class="form-field">
        <label class="field-label">Inspector</label>
        <input
          type="text"
          class="field-input field-input-readonly"
          [value]="inspectorNombre"
          readonly
          tabindex="-1"
        />
      </div>
      <div class="form-field">
        <label class="field-label">Supervisor</label>
        <mat-form-field class="field-select">
          <mat-select
            placeholder="Seleccione supervisor (opcional)"
            [(ngModel)]="supervisorId"
            (selectionChange)="onSupervisorChange()"
            (openedChange)="$event ? null : searchSupervisor.set('')"
          >
            <mat-option>
              <ngx-mat-select-search
                [(ngModel)]="searchSupervisor"
                placeholderLabel="Buscar supervisor..."
                noEntriesFoundLabel="No se encontraron usuarios"
              ></ngx-mat-select-search>
            </mat-option>
            <mat-option [value]="null">Sin asignar</mat-option>
            @for (usuario of supervisoresFiltrados(); track usuario.id) {
            <mat-option [value]="usuario.id">
              {{ usuario.nombre }} ({{ usuario.correo }})
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
      <div class="form-field">
        <label class="field-label">Técnicos</label>
        <mat-form-field class="field-select">
          <mat-select
            placeholder="Seleccione técnicos (opcional)"
            [(ngModel)]="tecnicoIds"
            (selectionChange)="onTecnicosChange()"
            (openedChange)="$event ? null : searchTecnicos.set('')"
            multiple
          >
            <mat-option>
              <ngx-mat-select-search
                [(ngModel)]="searchTecnicos"
                placeholderLabel="Buscar técnicos..."
                noEntriesFoundLabel="No se encontraron usuarios"
              ></ngx-mat-select-search>
            </mat-option>
            @for (usuario of tecnicosFiltrados(); track usuario.id) {
            <mat-option [value]="usuario.id">
              {{ usuario.nombre }} ({{ usuario.correo }})
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
      <div class="form-field">
        <label class="field-label">Número de Serie Motor</label>
        <input
          type="text"
          class="field-input"
          placeholder="Ej: MTR-12345"
          [value]="nSerieMotor()"
          (input)="nSerieMotor.set($any($event.target).value); onNSerieMotorChange()"
        />
      </div>
      <div class="form-field">
        <label class="field-label">Cabinado</label>
        <mat-form-field class="field-select">
          <mat-select
            placeholder="Sin especificar"
            [(ngModel)]="cabinado"
            (ngModelChange)="onCabinadoChange()"
          >
            <mat-option [value]="null">Sin especificar</mat-option>
            <mat-option [value]="true">Sí</mat-option>
            <mat-option [value]="false">No</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="form-field">
        <label class="field-label">Horómetro (horas)</label>
        <input
          type="number"
          class="field-input"
          placeholder="Ej: 1250.50"
          step="0.01"
          min="0"
          [value]="horometro()"
          (input)="
            horometro.set($any($event.target).value ? parseFloat($any($event.target).value) : null);
            onHorometroChange()
          "
          (keypress)="soloNumeros($event)"
        />
      </div>
    </div>
  </div>

  <!-- Checklists -->
  <div class="checklists-section">
    <div class="section-header">
      <div class="section-header-left">
        <mat-icon>checklist</mat-icon>
        <h2 class="section-title">Checklists de la Inspección</h2>
      </div>
      <button
        class="btn-primary"
        (click)="agregarChecklist()"
        [disabled]="!puedeAgregarChecklist()"
        [title]="
          puedeAgregarChecklist()
            ? 'Agregar nuevo checklist'
            : 'Complete los campos obligatorios para habilitar esta opción'
        "
      >
        <mat-icon>add</mat-icon>
        Agregar Checklist
      </button>
    </div>

    @if (checklists().length > 0) {
    <div class="progress-summary">
      <div class="summary-header">
        <span class="summary-count">
          {{ checklists().length }}
          {{ checklists().length === 1 ? 'checklist' : 'checklists' }}
        </span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="resumen().porcentajeCompletado"></div>
        </div>
        <span class="progress-text">{{ resumen().porcentajeCompletado.toFixed(0) }}%</span>
      </div>
      <div class="progress-stats-compact">
        <span class="stat-text stat-si">{{ resumen().itemsSI }} SÍ</span>
        <span class="stat-text stat-no">{{ resumen().itemsNO }} NO</span>
        <span class="stat-text stat-na">{{ resumen().itemsNA }} N/A</span>
        <span class="stat-text stat-pending">{{ resumen().itemsIncompletos }} Pendientes</span>
      </div>
    </div>

    <div class="checklists-list">
      @for (checklist of checklists(); track checklist.templateId; let checklistIndex = $index) {
      <div class="checklist-card">
        @if (checklist.templateId < 0) {
        <!-- Placeholder para seleccionar un checklist -->
        <div class="checklist-placeholder">
          <mat-form-field class="field-select">
            <mat-select
              placeholder="Seleccione un checklist para agregar"
              (selectionChange)="seleccionarTemplate(checklistIndex, $event.value)"
            >
              @for (template of templatesDisponibles(); track template.id) {
              <mat-option [value]="template" [disabled]="isChecklistSelected(template.id)">
                {{ template.titulo }}
              </mat-option>
              }
            </mat-select>
          </mat-form-field>
          <button
            class="btn-delete-checklist"
            (click)="eliminarChecklist(checklistIndex)"
            title="Eliminar"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>
        } @else {
        <!-- Checklist seleccionado -->
        <div class="checklist-header">
          <div class="checklist-title-section">
            <span class="checklist-number">#{{ checklistIndex + 1 }}</span>
            <span class="checklist-title">{{ checklist.nombreTemplate }}</span>
            <span
              class="checklist-badge"
              [class.badge-complete]="checklist.completado"
              [class.badge-progress]="
                !checklist.completado &&
                (checklist.progresoSI > 0 || checklist.progresoNO > 0 || checklist.progresoNA > 0)
              "
            >
              {{ checklist.progresoSI + checklist.progresoNO + checklist.progresoNA }}
              /
              {{ checklist.progresoTotal }}
            </span>
          </div>
          <button
            class="btn-delete-checklist"
            (click)="eliminarChecklist(checklistIndex)"
            title="Eliminar checklist"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="checklist-items">
          @for (item of checklist.items; track item.templateSeccionId; let itemIndex = $index) {
          <div
            class="item-row"
            [class.item-si]="item.cumple === true"
            [class.item-no]="item.cumple === false"
            [class.item-na]="item.cumple === null && item.eleccionRespuestaId"
          >
            <span class="item-number">{{ item.orden }}</span>
            <div class="item-description">
              <span class="item-text">{{ item.descripcion }}</span>
              @if (item.observacion) {
              <button
                class="btn-observacion-indicator"
                (click)="abrirObservacion(checklistIndex, itemIndex)"
                title="Ver observación"
              >
                <mat-icon>comment</mat-icon>
                <span
                  >Observación @if (item.observacion.archivos && item.observacion.archivos.length >
                  0) { + {{ item.observacion.archivos.length }}
                  {{ item.observacion.archivos.length === 1 ? 'Archivo' : 'Archivos' }}
                  }
                </span>
              </button>
              }
            </div>
            <div class="item-actions">
              <button
                class="btn-response btn-si"
                [class.active]="item.cumple === true"
                (click)="onRespuestaChange(checklistIndex, itemIndex, true)"
                title="Cumple"
              >
                <mat-icon>check</mat-icon>
                SÍ
              </button>
              <button
                class="btn-response btn-no"
                [class.active]="item.cumple === false"
                (click)="onRespuestaChange(checklistIndex, itemIndex, false)"
                title="No cumple"
              >
                <mat-icon>close</mat-icon>
                NO
              </button>
              <button
                class="btn-response btn-na"
                [class.active]="item.cumple === null && item.eleccionRespuestaId"
                (click)="onRespuestaChange(checklistIndex, itemIndex, null)"
                title="No aplica"
              >
                <mat-icon>remove</mat-icon>
                N/A
              </button>
              <button
                class="btn-observacion"
                [class.required]="requiereObservacion(item) && !item.observacion"
                (click)="abrirObservacion(checklistIndex, itemIndex)"
                [title]="
                  requiereObservacion(item) && !item.observacion
                    ? 'Observación requerida'
                    : 'Agregar/editar observación'
                "
              >
                <mat-icon>{{ item.observacion ? 'edit_note' : 'add_comment' }}</mat-icon>
              </button>
            </div>
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
    } @else {
    <div class="empty-state-templates">
      <mat-icon class="empty-icon">playlist_add</mat-icon>
      <p class="empty-message">Aún no has agregado ningún checklist a la inspección.</p>
      <p class="empty-message">Haz clic en "Agregar Checklist" para comenzar.</p>
    </div>
    }
  </div>

  <div class="end-actions">
    <button
      class="btn-primary"
      (click)="intentarTerminar()"
      [disabled]="!puedeTerminar()"
      [title]="puedeTerminar() ? 'Guardar inspección' : 'Complete todos los campos requeridos'"
    >
      Terminar Inspección
    </button>
  </div>
</div>

@if (showConfirmSalir()) {
<app-confirm-dialog
  [title]="'Salir sin guardar'"
  [message]="'¿Está seguro de que desea salir? Los cambios no guardados se perderán.'"
  [confirmText]="'Salir'"
  [cancelText]="'Continuar editando'"
  [type]="'warning'"
  (onConfirm)="confirmarSalir()"
  (onCancel)="cancelarSalir()"
/>
} @if (showConfirmTerminar()) {
<app-confirm-dialog
  [title]="'Terminar inspección'"
  [message]="
    '¿Está seguro de que desea finalizar esta inspección?\n\nTodos los checklists han sido completados y la inspección quedará registrada.'
  "
  [confirmText]="'Finalizar'"
  [cancelText]="'Continuar editando'"
  [type]="'info'"
  (onConfirm)="confirmarTerminar()"
  (onCancel)="cancelarTerminar()"
/>
}
